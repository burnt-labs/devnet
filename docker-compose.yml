services:
  haproxy:
    image: haproxy:2.9-alpine
    command: >
      haproxy -f /usr/local/etc/haproxy/haproxy.cfg
    depends_on:
      - xion
    networks:
      - default
    ports:
      - 1317:1317
      - 8444:8444
      - 9090:9090
      - 26657:26657
      - 26658:26658
    volumes:
      - ./config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro

  xion:
    image: ghcr.io/burnt-labs/xion/xion:${XIOND_VERSION:-latest}
    # build:
    #   context: ./xion
    command: >
      /usr/bin/cosmovisor run start \
        --api.address tcp://0.0.0.0:1317 \
        --api.enable true \
        --api.enabled-unsafe-cors true \
        --api.swagger true \
        --grpc.enable true \
        --grpc.address 0.0.0.0:9090 \
        --grpc-web.enable \
        --minimum-gas-prices 0.001uxion \
        --rpc.laddr tcp://0.0.0.0:26657 
    entrypoint: /home/xiond/init/entrypoint.sh
    deploy:
      replicas: ${NUM_VALIDATORS:-3}
    env_file:
      - .env
    ports:
      - 1317
      - 26656
      - 26657
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:26657/status"]
      interval: 5s
      timeout: 5s
      retries: 5
    user: root
    working_dir: /home/${DAEMON_NAME}
    networks:
      - default
    volumes:
      - /home/${DAEMON_NAME}
      - shared:/home/${DAEMON_NAME}/.shared
      - ./scripts/init:/home/${DAEMON_NAME}/init
      - ../xion/dist/xiond_linux_arm64_v8.0/bin/xiond-linux-arm64/:/home/${DAEMON_NAME}/.xiond/cosmovisor/genesis/bin/xiond
      - ../xion/dist/xiond_linux_arm64_v8.0/bin/xiond-linux-arm64/:/home/${DAEMON_NAME}/.xiond/cosmovisor/upgrades/v19/bin/xiond

  # xion-aa-api:
  #   build:
  #     context: ./xion-aa-api
  #   ports:
  #     - "3000"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/healthz/readiness"]
  #   networks:
  #     - default

  # xion-assets:
  #   build:
  #     context: xion-assets/
  #     args:
  #       ENV_FILE: .env.devnet
  #   ports:
  #     - "3000"
  #   networks:
  #     - default

  # xion-dashboard:
  #   build:
  #     context: xion-dashboard-app/
  #     args:
  #       ENV_FILE: .env.example
  #   ports:
  #     - "4173"
  #   depends_on:
  #     "xion-aa-api":
  #       condition: service_healthy
  #   healthcheck:
  #     test: [ "CMD", "curl", "-f", "http://localhost:4173" ]
  #   user: root
  #   networks:
  #     - default

  # xion-developer-portal:
  #   build:
  #     context: xion-developer-portal/
  #     args:
  #       VITE_DEPLOYMENT_ENV: .env.testnet2
  #   ports:
  #     - "3000"
  #   depends_on:
  #     "xion-dashboard":
  #       condition: service_healthy
  #   networks:
  #     - default

  xion-explorer:
    build:
      context: xion-explorer/
      args:
        VITE_DEPLOYMENT_ENV: devnet
    ports:
      - "5173"
    networks:
      - default

  xion-faucet:
    build:
      context: xion-faucet/
      args:
        DOTENV_FILE: .env.example
    env_file:
      - ./xion-faucet/.env.example
    ports:
      - "3000"
    networks:
      - default

  # xion-staking:
  #   build:
  #     context: ./xion-staking
  #   environment:
  #     ENV NEXT_PUBLIC_IS_DEPLOYMENT: "false"
  #     NEXT_PUBLIC_IS_PRO_MODE: "false"
  #     NEXT_PUBLIC_NETWORK_TYPE: "testnet"
  #     NEXT_PUBLIC_RPC_ENDPOINT: "http://localhost:26657"
  #     VITE_FEE_GRANTER_ADDRESS: "xion1e2fuwe3uhq8zd9nkkk876nawrwdulgv460vzg7"
  #   ports:
  #     - "8788"
  #   depends_on:
  #     "xion-aa-api":
  #       condition: service_healthy
  #   networks:
  #     - default

networks:
  default:

volumes:
  shared:
